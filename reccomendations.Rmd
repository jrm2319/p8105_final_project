---
title: "Get Book Recommendations!"
output: html_document
runtime: shiny
---

Welcome to our recommendations page! Looking for a new romance story? Want to get into some classics? Looking to read some other books by your favorite author? Fear not! You can get some book recommendations right here. You can search by your favorite genre, by author, and include the rating of the book your want. 

Have fun reading! 

```{r setup, include=FALSE}

library(tidyverse)
library(shiny)
library(bslib)
library(dplyr)

knitr::opts_chunk$set(echo = TRUE)

```

```{r, include=FALSE}

books = read_csv("books_with_tags.csv")

books_clean = books |> 
  select(-isbn, ratings_count, work_ratings_count, work_text_reviews_count)

rate = read_csv("ratings.csv")

rate_clean = rate |> 
  select(-user_id)


rec_data <- merge(books_clean, rate_clean, by = "book_id", all = TRUE)

```

```{r, echo=FALSE, warning=FALSE}

authors <- unique(rec_data$authors)

  titlePanel("Book Recommendations")

ui <- fluidPage(
  selectInput("search_by", 
              label = "Search by:", 
              choices = c("Select", "Author", "Genre")),

  conditionalPanel(
    condition = "input.search_by == 'Author'",
    selectizeInput("authors", 
                   label = "Start typing an author's name:", 
                   choices = authors, 
                   options = list(
                     placeholder = 'Select an author...',
                     create = FALSE, 
                     maxItems = 1,
                     highlight = TRUE))
  ),

  conditionalPanel(
    condition = "input.search_by == 'Genre'",
    selectInput("search_genre", 
                label = "Choose Genre(s):", 
                choices = unique(c(rec_data$top_1, rec_data$top_2, rec_data$top_3, rec_data$top_4, rec_data$top_5)), 
                multiple = TRUE)  
  ),
  
  conditionalPanel( 
    condition = "input.search_by == 'Genre' || input.search_by == 'Author'",
    selectInput("rating", 
                label = "Choose Rating:", 
                choices = unique(rec_data$rating), 
                selected = NULL)
  ),
  
  actionButton("recommend", "Get Recommendations"),
  
  h3("Recommended Books"),
  uiOutput("book_list")
)

server <- function(input, output, session) {
  
  filtered_books <- reactive({
    booktok <- rec_data
    
    if (length(input$search_genre) > 0) {
      booktok <- booktok %>%
        filter(
          top_1 %in% input$search_genre | 
          top_2 %in% input$search_genre | 
          top_3 %in% input$search_genre | 
          top_4 %in% input$search_genre | 
          top_5 %in% input$search_genre
        )
    }
    
    if (input$search_by == "Author" && input$authors != "") {
      booktok <- booktok %>% filter(authors == input$authors)
    }
    
    
    if (!is.null(input$rating) && input$rating != "") {
      booktok <- booktok %>% filter(rating == as.numeric(input$rating))
    }
    
    booktok %>% distinct(title, .keep_all = TRUE)
  })
  
  observeEvent(input$recommend, {
    output$book_list <- renderUI({
      booktok <- filtered_books()
      
      books_to_show <- head(booktok, 5)
      
      if (nrow(books_to_show) > 0) {
        tagList(
          lapply(1:nrow(books_to_show), function(i) {
            div(
              img(src = books_to_show$image_url[i], width = "250px", height = "300px"),  
              strong(books_to_show$title[i])
            )
          })
        )
      } else {
        p("No books found based on your selection.")
      }
    })
  })
}

shinyApp(ui = ui, server = server)


```